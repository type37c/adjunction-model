# Step 1 修正後の結果：ηの物理的意味の検証

**実験日**: 2026-02-19  
**修正内容**: Z座標フィルタリングの修正と点群内部充填の実装

---

## 1. 修正の概要

### 1.1. 発見された問題

初回のStep 1実験で、ηが完全に不変（0.025155）であることが判明しました。根本原因の調査により、以下の2つの問題が特定されました：

1. **Z座標フィルタリングの誤り**: カメラ座標系ではZ座標が負の値になるが、フィルタリングは正の値（0.4~1.0）を期待していたため、すべての点が除外されていた
2. **訓練データとの分布不一致**: Phase 1の訓練データは内部が埋まった形状だが、PyBulletの点群は表面のみ

### 1.2. 実装した修正

#### 修正1: Z座標フィルタリングの修正

```python
# Before
points = filter_point_cloud(points, z_min=0.4, z_max=1.0)

# After
points = filter_point_cloud(points, z_min=-2.0, z_max=0.0)
```

#### 修正2: 点群内部充填の実装

`point_cloud_filler.py`を実装し、表面の点群から内部を補間して埋める処理を追加：

```python
def fill_point_cloud_simple(surface_points, target_num_points=512, fill_ratio=0.7):
    # 70%を内部点、30%を表面点として生成
    # 内部点は、表面点から推定した球の内部にランダムにサンプリング
```

---

## 2. 実験結果

### 2.1. 全体統計（Box）

| 指標 | 値 |
|---|---|
| データポイント数 | 640 |
| 平均η | 0.027357 |
| 標準偏差 | 0.001273 |
| 最小値 | 0.024513 |
| 最大値 | 0.034588 |
| **変動係数** | **0.0465** |

**重要な発見**: 
- ηが変化するようになった（修正前は完全に不変）
- 変動係数0.0465は、Phase 1スタイルの点群（0.0925）の約半分
- ηの範囲: 0.0245~0.0346（約40%の変動幅）

### 2.2. 行動ごとのη統計（Box）

| 行動 | 平均η | 標準偏差 | 最小値 | 最大値 |
|---|---|---|---|---|
| **Static** | 0.02677 | 0.00097 | 0.02489 | 0.02879 |
| **Push** | 0.02713 | 0.00099 | 0.02466 | 0.02970 |
| **Topple** | 0.02728 | 0.00091 | 0.02475 | 0.02969 |
| **Rotate** | 0.02728 | 0.00101 | 0.02451 | 0.03001 |
| **Viewpoint Yaw 0°** | 0.02616 | 0.00077 | 0.02534 | 0.02723 |
| **Viewpoint Yaw 45°** | 0.02794 | 0.00080 | 0.02671 | 0.02870 |
| **Viewpoint Yaw 90°** | 0.02951 | 0.00086 | 0.02848 | 0.03048 |
| **Viewpoint Yaw 135°** | 0.03115 | 0.00085 | 0.03047 | 0.03259 |
| **Viewpoint Yaw 180°** | 0.02807 | 0.00124 | 0.02632 | 0.02934 |
| **Viewpoint Yaw 225°** | **0.03345** | 0.00127 | 0.03134 | **0.03459** |
| **Viewpoint Yaw 270°** | 0.03212 | 0.00033 | 0.03167 | 0.03241 |
| **Viewpoint Yaw 315°** | 0.02930 | 0.00151 | 0.02766 | 0.03097 |

### 2.3. 重要な観察

#### 観察1: 視点変更がηに最も大きな影響を与える

- **最小η**: Yaw 0° (0.02616) - 正面からの視点
- **最大η**: Yaw 225° (0.03345) - 斜め後ろからの視点
- **差**: 0.00729（約28%の増加）

これは、F/Gが**視点依存の特徴**を学習していることを示唆しています。特定の視点（Yaw 225°, 270°, 135°）で再構成誤差が高くなるのは、Phase 1の訓練データにその視点からの形状が少なかった可能性があります。

#### 観察2: 物理的相互作用（Push, Topple, Rotate）の影響は小さい

- Push, Topple, Rotateの平均ηは、Staticとほぼ同じ（0.0271~0.0273）
- 標準偏差も同程度（0.0009~0.0010）

これは、**オブジェクトの位置や姿勢の変化よりも、視点の変化の方がηに大きく影響する**ことを意味します。

#### 観察3: ηの変動は依然として小さい

- 全体の変動係数: 0.0465
- Phase 1スタイルの点群: 0.0925（約2倍）

点群内部充填により、ηが変化するようになりましたが、変動幅はPhase 1の訓練データの半分程度です。これは、**内部充填の方法が訓練データと完全には一致していない**ことを示唆しています。

---

## 3. Phase 2.1への影響

### 3.1. 内発的報酬としてのηの有効性

修正後のηは、以下の特性を持ちます：

**✓ 利点**:
- 視点変更に対して敏感に反応する（28%の変動）
- 一貫した傾向がある（特定の視点で常に高い/低い）
- ノイズが少ない（同じ条件で標準偏差0.0008程度）

**✗ 制限**:
- 物理的相互作用（押す、倒す、回転）に対する反応が鈍い
- 変動幅が小さい（Phase 1訓練データの半分）
- 視点依存性が強すぎる可能性がある

### 3.2. 報酬設計への示唆

#### シナリオA: ηをそのまま内発的報酬として使用

```python
r_intrinsic = α · Δη
```

**問題点**:
- ηが主に視点変化に反応するため、エージェントは「視点を変える」ことを学習する可能性がある
- オブジェクトとの物理的相互作用（本来の目的）よりも、カメラの動きを最適化してしまう

**対策**:
- カメラの視点を固定する、または視点変化を制限する
- ηの計算を複数視点の平均にする

#### シナリオB: ηを「新規性」の指標として使用

ηが高い = 訓練分布から外れている = 新しい状況

```python
r_intrinsic = α · max(0, η - η_baseline)
```

**利点**:
- エージェントは「訓練時に見たことのない状況」を探索する
- 視点変化だけでなく、オブジェクトの新しい姿勢も発見できる可能性

**問題点**:
- η_baselineの設定が恣意的
- 「新しい」ことが必ずしも「有益」とは限らない

#### シナリオC: タスク報酬のみを使用（内発的報酬を放棄）

修正後のηの挙動を見ると、**現時点では内発的報酬としての有効性が限定的**です。

**推奨**:
1. まずタスク報酬のみでPhase 2.1を実装する（Step 2）
2. F/Gのアフォーダンス特徴をAgent Cの状態表現に含める
3. 「F/G特徴を使うAgent C」と「使わないAgent C」の学習速度を比較する
4. 差が出れば、F/Gが有用であることの証拠となり、その時点で内発的報酬の導入を検討する

---

## 4. 次のステップ

### 優先度1: Step 2の実装

タスク報酬を用いた強化学習実験を実装し、F/Gのアフォーダンス特徴が実際に有用かを検証する。

### 優先度2（条件付き）: Phase 1の再訓練

Step 2でF/Gの有用性が確認できた場合、Phase 1を「表面のみの点群」で再訓練することを検討する。これにより、PyBulletの点群と訓練データの分布が一致し、ηの変動幅が大きくなる可能性がある。

### 優先度3（条件付き）: 内発的報酬の導入

Step 2でF/Gの有用性が確認でき、かつPhase 1の再訓練でηの変動幅が改善された場合、報酬の二重構造を導入する。

---

## 5. 結論

**修正は成功しました。ηが物理的相互作用（特に視点変化）に対して変化するようになりました。**

しかし、ηの変動幅は依然として小さく、特に物理的相互作用（押す、倒す、回転）に対する反応が鈍いです。これは、点群内部充填の方法が訓練データと完全には一致していないためと考えられます。

**現時点での推奨事項**:
- 内発的報酬の設計を議論する前に、まずStep 2（タスク報酬のみでの強化学習）を実装する
- F/Gのアフォーダンス特徴が実際に有用かを経験的に検証する
- その結果に基づいて、Phase 1の再訓練や内発的報酬の導入を判断する

**Step 1の最も重要な成果**:
- 理論的な議論だけでは見えなかった問題（Z座標フィルタリング、視点依存性）を発見できた
- 実験的検証の重要性を再確認できた
- Phase 2.1の設計に関する具体的なデータを得られた
