# Tensor Shape and Interface Specification - 2026年2月14日

## 1. 目的

本ドキュメントは、`adjunction-model`プロジェクトにおける主要なモデルコンポーネント間のインターフェース、特にテンソルの形状（shape）、次元（rank）、データ形式（グラフ形式/バッチ形式）を明確に定義するものである。

Phase 2 Slack実験の実装過程で明らかになったように、この仕様の欠如が連鎖的なバグの根本原因であった。今後の開発では、本仕様を遵守することで、同様の問題の再発を防止する。

## 2. 基本規約

### 2.1. データ形式: グラフ形式 (Graph Format) を正とする

- **グラフ形式**: バッチ内の全サンプル（点群）を単一のテンソルに結合し、各点がどのサンプルに属するかを示す`batch`インデックスを別途用意する方式。
    - `pos`: `(N, 3)` - Nはバッチ全体の総ポイント数
    - `batch`: `(N,)`
- **バッチ形式**: 各サンプルを独立した次元として保持する方式。
    - `pos`: `(B, P, 3)` - Bはバッチサイズ, Pはサンプル毎の点数

**規約**: Functor F, Gを含むコアモデルは、原則として**グラフ形式**の入力を受け付ける設計とする。データローダーは`collate_fn`を用いて、データをグラフ形式に変換する責務を負う。

### 2.2. 次元数 (Rank) の厳守

- スカラー値のように見えるデータも、バッチ処理を考慮して常に2次元 `(B, 1)` を基本とする。1次元 `(B,)` の使用は、後続の`torch.cat`などでエラーを引き起こすため、原則として避ける。

## 3. 主要コンポーネント仕様

### 3.1. データローダー (`collate_graph_batch`)

- **役割**: バッチ形式の生データを、モデルが要求するグラフ形式に変換する。

| I/O  | 名前        | 形状 (Shape) | 形式  | 説明                                     |
|------|-------------|--------------|-------|------------------------------------------|
| **入力** | `batch` (list) | `B`個の辞書     | Batch | 各辞書は `{'points': (P, 3), ...}`      |
| **出力** | `points`    | `(N, 3)`     | Graph | 全点の座標を結合したテンソル             |
|      | `batch`     | `(N,)`       | Graph | 各点がどのサンプルに属するかを示すインデックス |
|      | `affordances` | `(B, A)`     | Batch | 各サンプルの正解アフォーダンス           |

### 3.2. Functor F (`FunctorF`)

- **役割**: 形状（点群）からアフォーダンスを予測する。

| I/O  | 名前        | 形状 (Shape) | 形式  | 説明                     |
|------|-------------|--------------|-------|--------------------------|
| **入力** | `pos`       | `(N, 3)`     | Graph | 点群座標                 |
|      | `batch`     | `(N,)`       | Graph | バッチインデックス       |
| **出力** | `affordances` | `(N, A)`     | Graph | 各点のアフォーダンス予測 |

### 3.3. Functor G (`FunctorG`)

- **役割**: アフォーダンスから形状（点群）を再構成する。

| I/O  | 名前        | 形状 (Shape)      | 形式  | 説明                                     |
|------|-------------|-------------------|-------|------------------------------------------|
| **入力** | `affordances` | `(B, A)`          | Batch | 各サンプルのアフォーダンス表現           |
| **出力** | `reconstructed` | `(B, P, 3)`       | Batch | 再構成された点群（Pは`num_points`で指定） |

### 3.4. Agent Layer C (`AgentLayerC_v4`)

- **役割**: エージェントの内部状態を更新し、F/Gを調整するためのコンテキストを生成する。

| I/O  | 名前                      | 形状 (Shape) | 形式  | 説明                                     |
|------|---------------------------|--------------|-------|------------------------------------------|
| **入力** | `prev_state`              | `Dict`       | -     | 前のステップのエージェント状態           |
|      | `action`                  | `(B, A)`     | Batch | 実行された行動（アフォーダンス）         |
|      | `coherence_signal_scalar` | `(B, 1)`     | Batch | スカラーのCoherenceシグナル              |
|      | `coherence_signal_spatial`| `(N,)`       | Graph | 空間的なCoherenceシグナル                |
|      | `batch`                   | `(N,)`       | Graph | `coherence_signal_spatial`に対応するインデックス |
| **出力** | `new_state`               | `Dict`       | -     | 更新されたエージェント状態               |
|      | `context`                 | `(B, C_a)`   | Batch | F/G変調用のコンテキストベクトル          |
|      | `info`                    | `Dict`       | -     | 分析用の内部情報                         |

### 3.5. `ConditionalAdjunctionModelV4` (統合モデル)

- **役割**: 全てのコンポーネントを統合し、エンドツーエンドのforward passを実行する。
- **重要な責務**: Functor Gの出力（バッチ形式）をFunctor Fの入力（グラフ形式）に正しく変換する。

```python
# Gの出力 (B, P, 3) を Fの入力 (N, 3) に変換する処理
B, P, _ = reconstructed.shape
reconstructed_flat = reconstructed.reshape(B * P, 3)
batch_recon = torch.arange(B).repeat_interleave(P)
affordances_reencoded = self.F(reconstructed_flat, batch_recon, context)
```

## 4. 今後の開発への適用

- 新しいモジュールを実装する際は、まず本ドキュメントを参照し、インターフェースを遵守すること。
- モデルのアーキテクチャに変更を加える場合は、本ドキュメントも同時に更新すること。
- プルリクエストのレビューでは、本仕様に準拠しているかを確認項目をチェックリストに含めること。
