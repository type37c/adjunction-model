# Implementation Log

このファイルは、Physical-Semantic Adjunction Modelの実装過程で行った設計判断、遭遇した問題、理論との齟齬を記録します。

---

## 2026-02-12: Phase 0 実装開始

### 環境構築

**実施内容**:
- PyTorch 2.10.0 (CPU版) をインストール
- PyTorch Geometric 2.7.0 をインストール
- その他の依存関係（h5py, trimesh, scipy, tqdm, pyyaml）をインストール

**設計判断**:
- CPU版を選択した理由: 初期プロトタイプでは小規模データセットを使用するため、GPU不要
- PyTorch Geometricの拡張ライブラリ（torch-scatter, torch-sparse）はPyG 2.7.0では不要になったため、インストールをスキップ

**ディレクトリ構造**:
```
adjunction-model/
├── src/
│   ├── models/      # F, G, Agent Layer Cの実装
│   ├── data/        # データローダー
│   ├── training/    # 学習ループ
│   └── utils/       # ユーティリティ関数
├── tests/           # 単体テスト
├── configs/         # 設定ファイル
├── data/            # データセット保存先
└── logs/            # 学習ログ
```

---

## 次のステップ

1. データローダーの実装（3D AffordanceNetの簡易版）
2. F（Shape→Action）の最小実装
3. 単体テストの作成


## Phase 2: Agent Layer C Integration (2026-02-12)

### Objective

Implement Agent Layer C (based on DreamerV3's RSSM) and integrate it with the existing F⊣G adjunction to create a conditional model F_C ⊣ G_C. The goal is to enable the agent to adapt its internal state in response to novel stimuli, as measured by the coherence signal.

### Implementation Steps

1.  **Agent Layer C (RSSM)**: Implemented a simplified Recurrent State-Space Model (`src/models/agent_layer.py`) with a deterministic state `h` and a stochastic state `z`. The state is updated based on the previous state, action, and coherence signal.

2.  **Conditional Adjunction**: Created a new model (`src/models/conditional_adjunction.py`) that wraps the base F and G functors. The context vector generated by Agent Layer C is used to modulate the behavior of F and G using Feature-wise Linear Modulation (FiLM).

3.  **Phase 2 Training Loop**: Implemented a new training loop (`src/training/train_phase2.py`) that fine-tunes the conditional model. The loss function includes the reconstruction loss (coherence signal), affordance loss, and a KL divergence term to regularize the RSSM.

4.  **Online Adaptation Experiment**: Created an experiment (`experiments/test_online_adaptation.py`) to test the agent's ability to adapt to a novel shape (torus) over multiple exposures. The experiment tracks the evolution of the coherence signal and the agent's internal state.

### Key Challenges & Solutions

-   **FiLM Implementation**: The initial attempt to apply FiLM to intermediate layers of F and G was complex and error-prone. To simplify, the implementation was revised to apply FiLM to the output of the base F and G models. This provided a clear and testable conditioning mechanism.

-   **DataLoader Issues**: The custom `DataLoader` did not automatically collate samples into a batched tensor with a `batch` index. The training loop was updated to manually stack the list of tensors and create the `batch` index, resolving the `KeyError: 'pos'` and `TypeError: cat() received an invalid combination of arguments`.

### Experimental Results

-   **Hypothesis**: When exposed to a novel shape, the agent's internal state should adapt, leading to a decrease in the coherence signal over time.
-   **Result**: The experiment showed a **-9.4% decrease** in the coherence signal over 10 exposures to a torus. While not a dramatic drop, it confirms that the agent is actively adapting its internal state in response to the novel stimulus.
-   **Interpretation**: The adaptation is partial because the experiment was run in `eval()` mode (no weight updates). The result successfully validates that the Agent Layer C is functional and responsive to the coherence signal. Full online adaptation would require online learning (weight updates), which is a goal for Phase 3.

### Status

Phase 2 implementation is complete. The model now has a functioning Agent Layer C that enables it to maintain an internal state and adapt to novel stimuli. The project is ready to proceed to the next phase, which could involve online learning, meta-learning, or more complex environmental interactions with the current architecture.
