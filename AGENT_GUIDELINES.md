# AIエージェント開発ガイドライン

この文書は、本プロジェクトでAIコーディングエージェント（Manus、Claude Code等）を用いて開発を進める際の統一されたルールとベストプラクティスを定めたものです。セッションをまたいで開発の品質と一貫性を保つため、すべての開発エージェント（および人間）はこのガイドラインに従う必要があります。

## 3つの中核原則

我々の開発プロセスは、以下の3つの中核原則に基づいています。

1.  **コンテキストは王様 (Context is King):** AIエージェントの性能はコンテキストウィンドウの質と量に完全に依存します。我々の最優先事項は、各タスクにおいて、エージェントにクリーンで、高密度で、必要十分なコンテキストを提供することです。

2.  **構造がすべてを決定する (Structure is Everything):** プロジェクトのファイル構造とドキュメント構造が、開発の効率、品質、および引き継ぎの容易さを決定します。エージェントが自律的に動きやすいよう、予測可能で、自己説明的な構造を維持します。

3.  **検証なくしてマージなし (No Merge without Verification):** エージェントによって書かれたすべてのコードは、マージされる前に客観的な基準で検証されなければなりません。「動くように見える」は完了ではありません。「テストが通る」が完了の定義です。

## 実践的ワークフロー

すべての開発作業は、以下のサイクルに従います。

### 1. セッションの開始

-   **常に新しいセッションで始める:** 長く続いたセッションはコンテキストが汚染され、性能が劣化します。新しいタスクに取り掛かる際は、原則として新しいセッションを開始してください。
-   **最初に読むべき文書:** セッションを開始したら、まず以下のコマンドを実行し、プロジェクトの全体像と現在のタスクを把握してください。
    ```bash
    cat ARCHITECTURE.md
    cat TODO.md
    ```
-   **タスクの選択:** `TODO.md` の `Phase 1: Prototype Implementation` から、未完了のタスクを一つだけ選び、そのタスクに集中してください。一度に複数のタスクを並行して進めてはいけません。

### 2. 計画 (Plan)

-   **Plan Modeの活用:** 実装に入る前に、必ずPlan Mode（読み取り専用モード）で詳細な実装計画を立ててください。
-   **計画に含めるべきこと:**
    -   変更するファイルの一覧
    -   各ファイルで具体的に何をするか（関数の追加、クラスの修正等）
    -   どのようにテストするか
-   **自己レビュー:** 作成した計画を自己レビューし、`ARCHITECTURE.md` の設計思想と矛盾がないか、より効率的な方法はないかを確認してください。

### 3. 実装 (Implement)

-   **一度に一つのファイル:** 原則として、一度に一つのファイルを編集してください。複数のファイルを同時に変更すると、依存関係を見失いやすくなります。
-   **小さなコミット:** 一つの論理的な変更が完了したら、すぐにコミットしてください。「テストを追加」「エンコーダFのバックボーンを実装」など、粒度の細かいコミットを心がけてください。
-   **`TODO.md`の更新:** 担当したタスクが完了したら、`TODO.md`の該当項目にチェックを入れてください。

### 4. 検証 (Verify)

-   **テストの実行:** コードを変更した後は、必ず関連するテストを実行してください。
    ```bash
    # npm test src/models/encoder_f.test.ts  (特定のテストを実行)
    ```
-   **リンターと型チェック:** コミットする前に、必ずリンターと型チェッカーを実行し、コードスタイルと型の整合性を確認してください。
    ```bash
    # npm run lint
    # npm run typecheck
    ```

## バグへの対処法

バグが発見された場合、以下の手順に厳密に従ってください。これは「バグ発見のための使いまわせるファイル」の思想をプロセスとして実装したものです。

1.  **再現テストの作成:** バグを修正しようとする前に、まずそのバグを確実に再現する新しいテストケースを作成してください。このテストは、最初は失敗するはずです。
2.  **テストのコミット:** この「失敗するテスト」を、「Fails: (バグの簡単な説明)」というコミットメッセージでリポジトリにコミットしてください。
3.  **バグの修正:** その後、このテストが通るようにコードを修正してください。
4.  **修正のコミット:** テストが通ったら、修正したコードを「Fix: (バグの簡単な説明)」というコミットメッセージでコミットしてください。

このプロセスにより、すべてのバグがテストによってカバーされ、将来的なリグレッション（同内容のバグの再発）を防ぐことができます。

## ドキュメントの階層構造

本プロジェクトでは、以下の階層的なドキュメント構造を採用し、エージェントが必要なコンテキストを効率的に読み込めるようにします。

-   **`AGENT_GUIDELINES.md` (このファイル):** プロジェクト全体の普遍的な開発ルール。すべてのエージェントが最初に読むべき最上位のルールブック。
-   **`ARCHITECTURE.md`:** プロジェクトの技術的な設計思想。実装の詳細に迷ったときに立ち返るべき「設計の憲法」。
-   **`TODO.md`:** 現在のタスクリストと進捗状況。次に何をすべきかを知るための「作業指示書」。
-   **(将来的に) `src/models/AGENTS.md`:** 特定のディレクトリに固有のルール（例：「このディレクトリのモデルはすべて`torch.nn.Module`を継承すること」）を記述するためのファイル。エージェントがそのディレクトリ内のファイルを編集する際に、追加で読み込みます。
